<script>
      // 1] Global state - BEWARE

      var _state = {
        accordianOneUp: 0,
        accordianNames: {},
        accordianBodies: {},

        // Methods:
        /** Update state while adding entry to accordion */
        addEntry: function(name, json) {
           var index = _state.accordianOneUp
           _state.accordianOneUp++
           _state.accordianNames[index] = name
           _state.accordianBodies[index] = json
        },
        /** Update state when an entry is deleted */
        removeEntry: function(index) {
           delete _state.accordianNames[index]
           delete _state.accordianBodies[index]
        },
        /** Copies current state into an object and then resets the state */
        copyThenReset: function(mutableObj) {
           for (i in _state.accordianNames) {
               var name = _state.accordianNames[i]
               var json = _state.accordianBodies[i]
               mutableObj[name] = json
           }
           // Reset state
           _state.accordianOneUp = 0
           _state.accordianNames = {}
           _state.accordianBodies = {}
        }
      }

      // 2] Utility methods

      /** Validate names */
      function validateName(name) {
         return (null != name) && ("" != name) && (null == name.match(/["'&<>]/))
      }

      /** Stops user monkeying around while server controls are ongoing */
      function disableInput() {
         $("#accordion").addClass('disabledbutton');
      }
      /** Stops user monkeying around while server controls are ongoing */
      function enableInput() {
         $("#accordion").removeClass('disabledbutton');
      }

      // 3] Service interface

      /** Create a new data table UI element */
      function createNewAccordionElement(name, json) {
         google.script.run.withSuccessHandler(
            function(obj) {
               if (obj) {
                  _state.addEntry(name, json)
                 rebuildAccordion()
               } //(else request silently failed)
               enableInput()
            }
         ).withFailureHandler(
            function(msg) {
               enableInput()
               console.log("createTable: error: [" + JSON.stringify(msg) + "]")
               showStatus(JSON.stringify(msg, 3), 'Client Error')
            }
         ).createTable(name, json)
      }

      /** Create a new data table UI element */
      function updateAccordionElement(index, oldName, newName, json) {
         google.script.run.withSuccessHandler(
            function(obj) {
               if (obj && (oldName != newName)) { // else don't need to do anything
                  _state.removeEntry(index)
                  _state.addEntry(newName, json)
                  rebuildAccordion()
                  enableInput()
               } else { //(request failed or no input)
                  enableInput()
               }
            }
         ).withFailureHandler(
            function(msg) {
               enableInput()
               console.log("updateTable: error: [" + JSON.stringify(msg) + "]")
               showStatus(JSON.stringify(msg, 3), 'Client Error')
            }
         ).updateTable(oldName, newName, json)
      }

      /** Delete a new data table UI element */
      function deleteAccordionElement(name) {
         google.script.run.withSuccessHandler(
            function(obj) {
               rebuildAccordion()
               enableInput()
            }
         ).withFailureHandler(
            function(msg) {
               enableInput()
               console.log("deleteTable: error: [" + JSON.stringify(msg) + "]")
               showStatus(JSON.stringify(msg, 3), 'Client Error')
            }
         ).deleteTable(name)
      }

      /** Retrieves saved objects from the server and creates the data table UI elements */
      function buildAccordionTableFromSource() {
         google.script.run.withSuccessHandler(
             function(obj) {
                buildAccordionTable(obj)
             }
         ).withFailureHandler(
             function(msg) {
                console.log("listTableConfigs: error: [" + JSON.stringify(msg) + "]")
                showStatus(JSON.stringify(msg, 3), 'Client Error')
             }
         ).listTableConfigs()
      }

</script>
