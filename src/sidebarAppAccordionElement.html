<script>
      /** Builds the UI element that manages data tables*/
      function buildAccordionElement(index, name, json, isFirstElement) {
         if (!isFirstElement && !validateName(name)) {
            showStatus("Bad name: [" + name + "], can't contain [<>'\"]", "Client Error")
            return
         }

         // Manage global state:
         var tableName = ""
         if (isFirstElement) {
             _state.addEntry(defaultKey, json)
         } else {
            tableName = name
             _state.addEntry(name, json)
         }

         // Append to accordion

         var buttons = ""
         var tableTools = ""
         var tableToolsStyle = ""
         var nameEditor = ""
         var disabledNameEditor = ""
         if (isFirstElement) {
            buttons =
            `
            <div class="btn-toolbar">
                     <button id="create_${index}" type="button" class="btn btn-primary">Create</button>
                     <button id="test_${index}" type="button" class="btn btn-info">Test</button>
                     <button id="cancel_${index}" type="button" class="btn btn-warning">Cancel</button>
            </div>
            `
         } else {
            buttons =
            `
            <div class="btn-toolbar">
                   <button id="update_${index}" type="button" class="btn btn-primary">Update</button>
                   <button id="reset_${index}" type="button" class="btn btn-warning">Reset</button>
                   <button id="delete_${index}" type="button" class="btn btn-danger">Delete</button>
            </div>
            `

            nameEditor =
            `
              <span class="input-group-btn">
                <button id="editname_${index}" class="btn btn-default" type="button" data-toggle="tooltip" title="Edit name"><span class='glyphicon glyphicon-pencil'></span></button>
              </span>
            `

            tableTools =
            `
               <div class="btn-group pull-right no-padding" role="group">
                   <button id="query_${index}" class="btn btn-default btn-sm" type="button" data-toggle="tooltip" title="Refresh query"><span class='glyphicon glyphicon-refresh'></span></button>
                   <button id="move_${index}" class="btn btn-default btn-sm" type="button" data-toggle="tooltip" title="Move/resize range"><span class='glyphicon glyphicon-move'></span></button>
                </div>
            `
            tableToolsStyle = "style='padding-top: 6px;'"
            disabledNameEditor = "disabled"
         }

         var page =
         `<div id="accordion_${index}" class="panel panel-default">
            <div class="panel-heading clearfix">
                ${tableTools}
                <h4 class="panel-title" ${tableToolsStyle}>
                    <a id="toggleCollapse${index}" data-parent="#accordion"><b>${name}</b></a>
                </h4>
            </div>
            <div id="collapse${index}" class="panel-collapse collapse out">
                <div class="panel-body form-horizontal">
                  <div class="form-group">
                     ${buttons}
                  </div>
                  <div class="form-group"><div class="input-group">
                     <div class="input-group-addon">
                        <span class="input-group-text" id="basic-addon${index}">Name</span>
                     </div>
                     <input type="text" id="name_${index}" class="form-control" placeholder="Table Name" aria-describedby="basic-addon${index}" value="${tableName}" ${disabledNameEditor}>
                     ${nameEditor}
                  </div> </div>
                  <div class="form-group">
                     <select class="input-small form-control" id="type_${index}">
                        <option disabled selected value>(Choose type)</option>
                        <option value="tabs_unknown_${index}">Data</option>
                        <option value="tabs_agg_${index}">Aggregation/Map Reduce</option>
                        <option value="tabs_sql_${index}">SQL (requires license)</option>
                        <option value="tabs_mgmt_${index}">Management</option>
                        <option value="tabs_json_${index}">Advanced (raw JSON)</option>
                     </select>
                  </div>
                  <!-- The different data tables' definitions -->
                 <div class="tab-content" id="tabs_${index}">
                    <div class="tab-pane form-group" id="tabs_unknown_${index}">
                     </div>
                    <div class="tab-pane form-group" id="tabs_agg_${index}">
                       ${buildAggregationEditor(index)}
                     </div>
                    <div class="tab-pane form-group" id="tabs_sql_${index}">
                       ${buildSqlEditor(index)}
                     </div>
                    <div class="tab-pane form-group" id="tabs_mgmt_${index}">
                       ${buildManagementEditor(index)}
                     </div>
                    <div class="tab-pane form-group" id="tabs_json_${index}">
                       <div id="editor_${index}"></div>
                     </div>
                  </div>
                </div>
            </div>
         </div>`

        $("#accordion").append(page).append(function(){ // When complete

           // Build raw JSON editor

           var curr_editor = ace.edit(`editor_${index}`)
           curr_editor.session.setMode("ace/mode/json")
           curr_editor.session.setTabSize(3)
           curr_editor.session.setUseWrapMode(true)
           curr_editor.session.setValue(JSON.stringify(json, null, 3))

           // Register all the "child" event handlers
           // Add the index to all fields
           $(`#accordion_${index}`).each(function() {
              $(this).data("accordion_index", index)
              //(retrived from handler by $(this).data("accordion_index")
           });

           // Add collapse toggle handler

            $(`#toggleCollapse${index}`).click(function(){
               $(`#collapse${index}`).collapse('toggle')

               // Activate the right type
               if (!isFirstElement) {

                  var tableToTypeMap = {
                     sql_table: `tabs_sql_${index}`,
                     data_table: `tabs_unknown_${index}`,
                     aggregation_table: `tabs_agg_${index}`,
                     cat_table: `tabs_mgmt_${index}`,
                     json_table: `tabs_json_${index}`
                  }
                  var typeToActivate = ""
                  for (var typeKey in tableToTypeMap) {
                     var isThisType = getJson(json, [ typeKey, "enabled" ])
                     if (isThisType) {
                        typeToActivate = tableToTypeMap[typeKey] || ""
                     }
                  }
                  if (typeToActivate != "") {
                     $(`#type_${index}`).val(typeToActivate)
                     onTableSelection(typeToActivate)
                  }
               }
            });

          var onTableSelection = function(tab) {
              $(`#tabs_${index} .tab-pane`).removeClass('active')
              $(`#${tab}`).addClass('active');

              if (tab == `tabs_json_${index}`) {
                 ace.edit(`editor_${index}`).resize()
              } else { //(group all the "non raw" editors together)
                // Update which table we're using and perform any required redraw logic:
                onSelectSqlEditor(index, tab == `tabs_sql_${index}`, curr_editor)
                onSelectManagementEditor(index, tab == `tabs_mgmt_${index}`, curr_editor)
                //TODO: other options
              }
          }

          // Add table selection handler

           $(`#type_${index}`).on('change', function () {
              var tab = $(this).val()
              onTableSelection(tab)
           });

           //TODO + others
           registerAggregationEditor(index, name, json, curr_editor)
           registerSqlEditor(index, name, json, curr_editor)
           registerManagementEditor(index, name, json, curr_editor)

           // Register event handler on raw JSON
           curr_editor.session.on('change', function(delta) {
             if (!tempDisableJsonChange) { //(if true this is being called because of an eg SQL change)
               try {
                  var newJson = JSON.parse(curr_editor.session.getValue()) //(do nothing until valid)
               } catch {
                  return
               }
               tempDisableJsonChange = true
               try {
                  //TODO + others
                  populateAggregationEditor(index, name, newJson, null)
                  populateSqlEditor(index, name, newJson, null)
                  populateManagementEditor(index, name, newJson, null)
               } catch (err) {
                  tempDisableJsonChange = false
                  throw err
               }
               tempDisableJsonChange = false
             }
          });

           // Add button handlers

           if (isFirstElement) { //create, cancel

              // Action buttons

              $(`#create_${index}`).click(function(){
                 var newName = $(`#name_${index}`).val()
                 if (!validateName(newName)) {
                    showStatus("New table name must be non-empty and valid", 'Client Error')
                 } else {
                    try {
                       var jsonStr = curr_editor.session.getValue()
                       var jsonBody = JSON.parse(jsonStr) //(throws if not valid JSON)
                       // Call server-side to add new accordian
                       disableInput()
                       createNewAccordionElement(newName, jsonBody)
                    } catch (err) {
                       enableInput() //(just in case createNewAccordionElement throws)
                       showStatus("Updated JSON invalid: [" + err.message + "]", 'Client Error')
                    }
                    //TODO: and apply the query one creation is complete
                 }
              });
              $(`#test_${index}`).click(function(){
                 var jsonStr = curr_editor.session.getValue()
                 var jsonBody = JSON.parse(jsonStr) //(throws if not valid JSON)
                 populateTable(name, jsonBody)
              });
              $(`#cancel_${index}`).click(function(){
                $(`#name_${index}`).val("")
                curr_editor.session.setValue(JSON.stringify(json, null, 3))
              });
           } else { // query, move - edit name - update, reset, delete

              // Top button bar

              $(`#move_${index}`).click(function(){
                 google.script.run.showTableRangeManager(name)
              });

              $(`#query_${index}`).click(function(){
                 var jsonStr = curr_editor.session.getValue()
                 var jsonBody = JSON.parse(jsonStr) //(throws if not valid JSON)
                 populateTable(name, jsonBody)
              });

              // Name editing

              $(`#editname_${index}`).click(function(){
                $(`#name_${index}`).prop('disabled', function(i, v) { return !v; });
              });

              // Action buttons

              $(`#delete_${index}`).click(function(){
                 _state.removeEntry(index)
                 disableInput()
                 try {
                    deleteAccordionElement(name)
                 } catch (err) {
                    enableInput() //(just in case createNewAccordionElement throws)
                    showStatus("Unexpected error deleting table entry: [" + err.message + "]", 'Client Error')
                 }
              });
              $(`#reset_${index}`).click(function(){
                $(`#name_${index}`).val(name)
                curr_editor.session.setValue(JSON.stringify(json, null, 3))
              });
              $(`#update_${index}`).click(function(){
                 var newName = $(`#name_${index}`).val()
                 if (!validateName(name)) {
                    showStatus("Updated table name must be non-empty and valid", 'Client Error')
                 } else {
                    try {
                       var jsonStr = curr_editor.session.getValue()
                       var jsonBody = JSON.parse(jsonStr) //(throws if not valid JSON)
                       // Call server-side to add new accordian
                       disableInput()
                       updateAccordionElement(index, name, newName, jsonBody)
                    } catch (err) {
                       enableInput() //(just in case createNewAccordionElement throws)
                       showStatus("Updated JSON invalid: [" + err.message + "]", 'Client Error')
                    }
                 }
                 //TODO: I think we want to refresh the query here (after the update is complete)?
              });
           }
        });
      }

      /** Rebuilds the accordion following a complex table change (delete/update-name/create) */
      function rebuildAccordion() {

         // Rebuild state
         var obj = {}
         _state.copyThenReset(obj)
         // Rebuild table
         $("#accordion").empty()
         buildAccordionTable(obj)

         //TODO: keep entries that are already open, open
      }

      /** Builds the accordion table from an object (user created or from server) */
      function buildAccordionTable(obj) {
          // First element is always the "create":
          if (obj.hasOwnProperty(defaultKey)) {
             buildAccordionElement(_state.accordianOneUp, "<div class='text-primary'>Build New Table...</div>", obj[defaultKey], /*isFirstElement=*/true)
          }

          // Then the others (sorted)
          var sortedKeys = []
          for (var key in obj) {
             sortedKeys.push(key)
          }
          sortedKeys.sort()
          for (var index in sortedKeys) {
              var key = sortedKeys[index]
              if ((key != defaultKey) && (obj.hasOwnProperty(key))) {
                 buildAccordionElement(_state.accordianOneUp, key, obj[key], /*isFirstElement=*/false)
              }
          }
      }

</script>
