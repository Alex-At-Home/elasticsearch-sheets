<script>

   /** Builds the forms that define the generation of SQL generation */
   function buildSqlEditor(index) {

       var accordion =
       `
<div id="accordion_sql_${index}" class="panel-group">
    <div class="panel panel-default">
        <div class="panel-heading">
            <h4 class="panel-title">
                <a data-toggle="collapse" data-parent="#accordion_sql_${index}" href="#accordion_general_sql_${index}">General</a>
            </h4>
        </div>
        <div id="accordion_general_sql_${index}" class="panel-collapse collapse out">
            <div class="panel-body form-horizontal">
               ${buildGeneralEditor(index, 'sql')}
            </div>
        </div>
        <div class="panel-heading">
            <h4 class="panel-title">
                <a data-toggle="collapse" data-parent="#accordion_sql_${index}" href="#accordion_edit_sql_${index}">SQL</a>
            </h4>
        </div>
        <div id="accordion_edit_sql_${index}" class="panel-collapse collapse in">
            <div class="panel-body">
               <div id="editor_sql_${index}"></div>
            </div>
        </div>
    </div>
</div>
       `
     return accordion
   }

   /** Handles elements that need custom redraw logic if the underlying fields were changed */
   function redrawSqlEditor(index) {
      ace.edit(`editor_sql_${index}`).resize()
   }

   /** Populate the data for this form */
   function populateSqlEditor(index, name, json, curr_sql_editor) {
       var sqlEditor = curr_sql_editor || ace.edit(`editor_sql_${index}`)
       populateGeneralEditor(index, name, json, 'sql')
       var sql = getJson(json, [ "sql_table", "query" ]) || ""
       sqlEditor.session.setValue(sql)
   }

   /** Called once all the HTML elements for this SQL table exist, populates the data and registers event handlers */
   function registerSqlEditor(index, name, json, curr_editor) {

     registerGeneralEditor(index, name, json, curr_editor, 'sql')

     // Build SQL editor
     var curr_sql_editor = ace.edit(`editor_sql_${index}`)
     curr_sql_editor.session.setMode("ace/mode/sql")
     curr_sql_editor.session.setTabSize(3)
     curr_sql_editor.session.setUseWrapMode(true)

     populateSqlEditor(index, name, json, curr_sql_editor) //(before we register the handler)

     curr_sql_editor.session.on('change', function(delta) {
         updateRawJson(curr_editor, function(currJson) {
           var sql = getOrPutJsonObj(currJson, [ "sql_table" ])
           sql.query = curr_sql_editor.session.getValue()
        })
    });

}
</script>
