<script>

   /** Builds the forms that define the generation of cat generation */
   function buildManagementEditor(index) {

       var accordion =
       `
<div id="accordion_mgmt_${index}" class="panel-group">
    <div class="panel panel-default">
        <div class="panel-heading">
            <h4 class="panel-title">
                <a data-toggle="collapse" data-parent="#accordion_mgmt_${index}" href="#accordion_general_mgmt_${index}">General</a>
            </h4>
        </div>
        <div id="accordion_general_mgmt_${index}" class="panel-collapse collapse out">
            <div class="panel-body form-horizontal">
               ${GeneralEditor.buildHtmlStr(index, 'mgmt')}
            </div>
        </div>
        <div class="panel-heading">
            <h4 class="panel-title">
                <a data-toggle="collapse" data-parent="#accordion_mgmt_${index}" href="#accordion_edit_mgmt_${index}">Management</a>
            </h4>
        </div>
        <div id="accordion_edit_mgmt_${index}" class="panel-collapse collapse in">
            <div class="panel-body">
               <div class="form-group">
                  <div class="input-group">
                     <div class="input-group-addon">
                         <span class="input-group-text">_cat/</span>
                     </div>
                     <input type="text" class="form-control" placeholder="" value="" id="endpoint_mgmt_${index}">
                  </div>
               </div>
               <div class="form-group">
                  <label for="options_mgmt_${index}">Options (one per line)</label>
                  <textarea class="form-control vertical-resize-only" rows="5" id="options_mgmt_${index}"></textarea>
               </div>
            </div>
        </div>
    </div>
</div>
       `
     return accordion
   }

   /** Handles elements that need custom redraw logic if the underlying fields were changed */
   function onSelectManagementEditor(index, selected, curr_editor) {
      // Update top-level JSON since we're switching mode
      Util.updateRawJsonNow(curr_editor, function(currJson) {
           var cat = Util.getOrPutJsonObj(currJson, [ "cat_table" ])
           cat.enabled = selected
      })
   }

   /** Populate the data for this form */
   function populateManagementEditor(index, name, json) {
       GeneralEditor.populate(index, name, json, 'mgmt')
       var cat = Util.getJson(json, [ "cat_table" ]) || {}
       $(`#endpoint_mgmt_${index}`).val(cat.endpoint || "")
       $(`#options_mgmt_${index}`).val((cat.options || []).join("\n"))
   }

   var listOfCatOptions = [
      "recovery", "indices", "shards", "nodes", "snapshots"
   ]

   /** Called once all the HTML elements for this Management table exist, populates the data and registers event handlers */
   function registerManagementEditor(index, name, json, curr_editor) {

     populateManagementEditor(index, name, json) //(before we register the handlers - note calls GeneralEditor.populate)

     // General handlers

     GeneralEditor.register(index, name, json, curr_editor, 'mgmt')

     // Management specific handlers:

     $(`#accordion_edit_mgmt_${index}`).on('shown.bs.collapse', function () {
        onSelectManagementEditor(index, /*selected*/ true, curr_editor) //(ensures all the elements are redrawn as we change the display settings)
     })

     $(`#options_mgmt_${index}`).on('input', function() {
         var options = $(this).val().split("\n").map(function(x) { return x.trim() }).filter(function(x) { return x != "" })
         Util.updateRawJson(curr_editor, function(currJson) {
           var cat = Util.getOrPutJsonObj(currJson, [ "cat_table" ])
           cat.options = options
        })
     })

     $(`#endpoint_mgmt_${index}`).autocomplete({
        minLength: 0,
        source: function(request, response) {
           var data = $.grep(listOfCatOptions, function(value) {
              return value.substring(0, request.term.length).toLowerCase() == request.term.toLowerCase()
           });
           response(data)
        },
        change: function( event, ui ) {
            var endpoint = $(`#endpoint_mgmt_${index}`).val()
            Util.updateRawJson(curr_editor, function(currJson) {
              var cat = Util.getOrPutJsonObj(currJson, [ "cat_table" ])
              cat.endpoint = endpoint
          })
        }
     }).focus(function () {
        if ("" == $(this).val()) { // only insta-display options if textbox empty
           $(this).autocomplete("search", "")
        }
     })

}
</script>
