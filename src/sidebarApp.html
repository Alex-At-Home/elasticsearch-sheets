<!DOCTYPE html>
<html>

<head>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/jquery-ui-bootstrap/0.5pre/css/custom-theme/jquery-ui-1.10.0.custom.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
    <style type="text/css" media="screen">
	   .ace_editor {
          height: 500px;
		  width: 100%;
	   }
	   .medium_ace_editor {
	     height: 300px;
	     width: 100%;
	   }
	   .small_ace_editor {
	     height: 100px;
	     width: 100%;
	   }
       .disabledbutton {
          pointer-events: none;
          opacity: 0.4;
       }
       .btn-toolbar{
          text-align: center;
       }
       .for-shorter-text {
          min-width: 75px;
       }
       .for-longer-text {
          min-width: 120px;
       }
       .vertical-resize-only {
          resize:vertical;
       }
    </style>
    <base target="_top">
</head>

<body>

    <div class="panel-group" id="accordion"></div>

    <!-- Dependencies -->

   <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
   <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/jquery-ui.min.js"></script>
   <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.2/ace.js"></script>

   <!-- Post-dependency initialization -->

   <script>

      /** Templated field provided by server (indicates the key corresponding to default JSON for new elements) */
      var defaultKey = "<?= defaultKey ?>"

      // Misc utils:

      /** Status/error display */
      function showStatus(message, summary) {
         google.script.run.showStatus(message, summary)
      }

      /** quick and dirty way of avoiding circular event changes -
        * apart from one place (the raw JSON editor), this should not be needed in "client" code
        */
      var tempDisableJsonChange = false
      var jsonUpdateTimerId
      var jsonUpdateTimerInterval = 200 //ms

      /** Update the raw JSON in the ACE code editor */
      function updateRawJson(editor, updateFn) {
         clearTimeout(jsonUpdateTimerId)
         jsonUpdateTimerId = setTimeout(function() { updateRawJsonNow(editor, updateFn) } , jsonUpdateTimerInterval)
      }
      function updateRawJsonNow(editor, updateFn) {
        if (!tempDisableJsonChange) {
          var jsonStr = editor.session.getValue()
          try {
             var jsonBody = JSON.parse(jsonStr) //(throws if not valid JSON)
          } catch {
             return // (just do nothing until JSON is valid)
          }

          updateFn(jsonBody)
          var newJsonStr = JSON.stringify(jsonBody, null, 3)

          tempDisableJsonChange = true  //(avoids eg SQL -> raw JSON -> SQL circle)
          try {
               editor.session.setValue(newJsonStr)
          } catch (err) {
               tempDisableJsonChange = false
               throw err
          }
          tempDisableJsonChange = false
        }
     }

      /** Gets a nested JSON element */
      function getJson(json, fieldArray) {
         var tmpJson = json
         for (var j in fieldArray) {
            var key = fieldArray[j]
            if (tmpJson.hasOwnProperty(key)) {
               tmpJson = tmpJson[key]
            } else {
               return null
            }
         }
         return tmpJson
      }

      /** Gets a nested JSON element object, creates it if it doesn't exist */
      function getOrPutJsonObj(json, fieldArray) {
         var tmpJson = json
         for (var j in fieldArray) {
            var key = fieldArray[j]
            if (tmpJson.hasOwnProperty(key)) {
               tmpJson = tmpJson[key]
            } else {
               var tmp = {}
               tmpJson[key] = tmp
               return tmp
            }
         }
         return tmpJson
      }

   </script>

   <!-- HTML and jquery code for the general editor in the top level accordion -->
   <?!= HtmlService.createHtmlOutputFromFile('sidebarAppGeneralEditor').getContent(); ?>

   <!-- HTML and jquery code for the Aggregation editor in the top level accordion -->
   <?!= HtmlService.createHtmlOutputFromFile('ElasticsearchAggregationInfo').getContent(); ?>
   <?!= HtmlService.createHtmlOutputFromFile('sidebarAppAggregationForm').getContent(); ?>
   <?!= HtmlService.createHtmlOutputFromFile('sidebarAppAggregationTableEditor').getContent(); ?>

   <!-- HTML and jquery code for the SQL editor in the top level accordion -->
   <?!= HtmlService.createHtmlOutputFromFile('sidebarAppSqlTableEditor').getContent(); ?>

   <!-- HTML and jquery code for the Management (_cat) editor in the top level accordion -->
   <?!= HtmlService.createHtmlOutputFromFile('sidebarAppManagementTableEditor').getContent(); ?>

   <!-- HTML and jquery code for the top level accordion -->
   <?!= HtmlService.createHtmlOutputFromFile('sidebarAppAccordion').getContent(); ?>

   <!-- HTML and jquery code for the accordion element's entries -->
   <?!= HtmlService.createHtmlOutputFromFile('sidebarAppAccordionElement').getContent(); ?>

   <script>

      // Create the tables UI elements on load
      buildAccordionTableFromSource()

   </script>

   <!-- All of the ES client related logic (including its interface with the backend server) -->
   <?!= HtmlService.createHtmlOutputFromFile('elasticsearchManager').getContent(); ?>

</body>

</html>
