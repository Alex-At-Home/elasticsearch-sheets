<script>

   /** The non-dynamic (bucket/metric) fields for aggregations */
   var mapReduceFields_ = [ "query", "params", "init", "map", "combine", "reduce", "lib" ]

   /** Builds the forms that define the generation of Aggregation queries */
   function buildAggregationEditor(index, standaloneEdit) {
       var groupCollapse = ''
       if (!standaloneEdit) {
          groupCollapse = `data-parent="#accordion_agg_${index}"`
       }

       var accordion =
       `
<div id="accordion_agg_${index}" class="panel-group">
    <div class="panel panel-default">
        <div class="panel-heading">
            <h4 class="panel-title">
                <a data-toggle="collapse" ${groupCollapse} href="#accordion_general_agg_${index}">General</a>
            </h4>
        </div>
        <div id="accordion_general_agg_${index}" class="panel-collapse collapse out">
            <div class="panel-body form-horizontal">
               ${buildGeneralEditor(index, 'agg')}
            </div>
        </div>

        <div class="panel-heading">
            <h4 class="panel-title">
                <a data-toggle="collapse" ${groupCollapse} href="#accordion_query_agg_${index}">Query</a>
            </h4>
        </div>
        <div id="accordion_query_agg_${index}" class="panel-collapse collapse out">
            <div class="panel-body">
               <div id="query_agg_${index}" class="medium_ace_editor"></div>
            </div>
        </div>

        <div class="panel-heading">
            <h4 class="panel-title">
                <a data-toggle="collapse" ${groupCollapse} href="#accordion_buckets_agg_${index}">Buckets (eg groupings)</a>
            </h4>
        </div>
        <div id="accordion_buckets_agg_${index}" class="panel-collapse collapse out">
            <div class="panel-body">
               <div id="buckets_agg_${index}"></div>
               <div class="btn-toolbar">
                  <button class="btn btn-default" id="add_bucket_agg_${index}">Add Bucket</button>
               </div>
            </div>
        </div>

        <div class="panel-heading">
            <h4 class="panel-title">
                <a data-toggle="collapse" ${groupCollapse} href="#accordion_metrics_agg_${index}">Metrics (inc Map Reduce)</a>
            </h4>
        </div>
        <div id="accordion_metrics_agg_${index}" class="panel-collapse collapse out">
            <div class="panel-body">
               <div id="metrics_agg_${index}"></div>
               <div class="btn-toolbar">
                  <button class="btn btn-default" id="add_metric_agg_${index}">Add Metric</button>
               </div>
               <div class="btn-toolbar">
                  <button class="btn btn-default" id="add_mapr_agg_${index}">Add Map Reduce Task</button>
               </div>
            </div>
        </div>

        <div class="panel-heading">
            <h4 class="panel-title">
                <a data-toggle="collapse" ${groupCollapse} href="#accordion_pipelines_agg_${index}">Pipelines (eg sort/filter)</a>
            </h4>
        </div>
        <div id="accordion_pipelines_agg_${index}" class="panel-collapse collapse out">
            <div class="panel-body">
               <div id="pipelines_agg_${index}"></div>
               <div class="btn-toolbar">
                  <button class="btn btn-default" id="add_pipeline_agg_${index}">Add Pipeline</button>
               </div>
            </div>
        </div>

       <!------------------------------------------------------------------------------------->
       <hr/>

        <div class="panel-heading">
            <h4 class="panel-title">
                <a data-toggle="collapse" ${groupCollapse} href="#accordion_params_agg_${index}">(MR) Parameters</a>
            </h4>
        </div>
        <div id="accordion_params_agg_${index}" class="panel-collapse collapse out">
            <div class="panel-body">
               <div id="params_agg_${index}" class="medium_ace_editor"></div>
            </div>
        </div>

        <div class="panel-heading">
            <h4 class="panel-title">
                <a data-toggle="collapse" ${groupCollapse} href="#accordion_init_agg_${index}">(MR) Init Script</a>
            </h4>
        </div>
        <div id="accordion_init_agg_${index}" class="panel-collapse collapse out">
            <div class="panel-body">
               <div id="init_agg_${index}" class="medium_ace_editor"></div>
            </div>
        </div>

        <div class="panel-heading">
            <h4 class="panel-title">
                <a data-toggle="collapse" ${groupCollapse} href="#accordion_map_agg_${index}">(MR) Map Script</a>
            </h4>
        </div>
        <div id="accordion_map_agg_${index}" class="panel-collapse collapse out">
            <div class="panel-body">
               <div id="map_agg_${index}" class="ace_editor"></div>
            </div>
        </div>

        <div class="panel-heading">
            <h4 class="panel-title">
                <a data-toggle="collapse" ${groupCollapse} href="#accordion_combine_agg_${index}">(MR) Combine Script</a>
            </h4>
        </div>
        <div id="accordion_combine_agg_${index}" class="panel-collapse collapse out">
            <div class="panel-body">
               <div id="combine_agg_${index}" class="ace_editor"></div>
            </div>
        </div>

        <div class="panel-heading">
            <h4 class="panel-title">
                <a data-toggle="collapse" ${groupCollapse} href="#accordion_reduce_agg_${index}">(MR) Reduce Script</a>
            </h4>
        </div>
        <div id="accordion_reduce_agg_${index}" class="panel-collapse collapse out">
            <div class="panel-body">
               <div id="reduce_agg_${index}" class="ace_editor"></div>
            </div>
        </div>

        <div class="panel-heading">
            <h4 class="panel-title">
                <a data-toggle="collapse" ${groupCollapse} href="#accordion_lib_agg_${index}">(MR) Library Functions</a>
            </h4>
        </div>
        <div id="accordion_lib_agg_${index}" class="panel-collapse collapse out">
            <div class="panel-body">
               <div id="lib_agg_${index}" class="ace_editor"></div>
            </div>
        </div>
    </div>
</div>
       `
     return accordion
   }

   /** Handles elements that need custom redraw logic if the underlying fields were changed */
   function onSelectAggregationEditor(index, selected, curr_editor) {
      // Update top-level JSON since we're switching mode
      updateRawJsonNow(curr_editor, function(currJson) {
           var aggregationTable = getOrPutJsonObj(currJson, [ "aggregation_table" ])
           aggregationTable.enabled = selected
      })
      // Display redraw:
      if (selected) {
         //TODO bucket and metrics
         // MR params
         mapReduceFields_.forEach(function(field) {
            ace.edit(`${field}_agg_${index}`).resize()
         })
      }
   }

   /** Populate the data for this form */
   function populateAggregationEditor(index, name, json, globalEditor) {

       // General

       populateGeneralEditor(index, name, json, 'agg')

       // Buckets and metrics

       // Clear any existing elements
       $(`#pipelines_agg_${index}`).empty()
       $(`#metrics_agg_${index}`).empty()
       $(`#buckets_agg_${index}`).empty()

       var buckets = getJson(json, [ "aggregation_table", "buckets" ]) || []
       buckets.forEach(function(bucket) {
          buildAggregationForm(index, 'bucket', globalEditor, `buckets_agg_${index}`, bucket)
       })
       var metrics = getJson(json, [ "aggregation_table", "metrics" ]) || []
       metrics.forEach(function(metric) {
          var aggType = 'metric'
          if (metric.map_reduce) {
             aggType = 'mapr'
          }
          buildAggregationForm(index, 'metric', globalEditor, `metrics_agg_${index}`, metric)
       })
       var pipelines = getJson(json, [ "aggregation_table", "pipelines" ]) || []
       buckets.forEach(function(bucket) {
          buildAggregationForm(index, 'pipeline', globalEditor, `buckets_agg_${index}`, bucket)
       })

       // MR
       mapReduceFields_.forEach(function(field) {
          var fieldPath = [ "aggregation_table", "map_reduce", field ]
          if ("query" == field) {
            fieldPath = [ "aggregation_table", field ]
          }
          var mrCode = getJson(json, fieldPath) || "" //TODO: move query off this
           if (("query" == field) || ("params" == field)) { //(these are JSON)
             mrCode = JSON.stringify(mrCode, null, 3)
           }
          ace.edit(`${field}_agg_${index}`).session.setValue(mrCode)
       })
   }

   /** Called once all the HTML elements for this SQL table exist, populates the data and registers event handlers */
   function registerAggregationEditor(index, name, json, curr_editor) {

     registerGeneralEditor(index, name, json, curr_editor, 'agg')

      mapReduceFields_.forEach(function(field) {
           var editorId = `${field}_agg_${index}`
           var curr_mr_editor = ace.edit(editorId)
           if (("query" == field) || ("params" == field)) {
              curr_mr_editor.session.setMode("ace/mode/json")
           } else {
              curr_mr_editor.session.setMode("ace/mode/java")
           }
           curr_mr_editor.session.setTabSize(3)
           curr_mr_editor.session.setUseWrapMode(true)
           //contents set from "populateAggregationEditor" below
      })

      // Populate all the fields:
      populateAggregationEditor(index, name, json, curr_editor)

      // Now add the handlers:

      $(`#add_bucket_agg_${index}`).click(function(){
         buildAggregationForm(index, 'bucket', curr_editor, `buckets_agg_${index}`)
      })
      $(`#add_metric_agg_${index}`).click(function(){
         buildAggregationForm(index, 'metric', curr_editor, `metrics_agg_${index}`)
      })
      $(`#add_mapr_agg_${index}`).click(function(){
         buildAggregationForm(index, 'mapr', curr_editor, `metrics_agg_${index}`)
      })
      $(`#add_pipeline_agg_${index}`).click(function(){
         buildAggregationForm(index, 'pipeline', curr_editor, `pipelines_agg_${index}`)
      })

      // Change triggers for all the MR code
      mapReduceFields_.forEach(function(field) {
         var editorId = `${field}_agg_${index}`
         var curr_mr_editor = ace.edit(editorId)
         curr_mr_editor.session.on('change', function(delta) {
            updateRawJson(curr_editor, function(currJson) {
               var codePath = [ "aggregation_table", "map_reduce" ]
               if ("query" == field) {
                  codePath = [ "aggregation_table" ]
               }
               var code = getOrPutJsonObj(currJson, codePath)
               if (("query" == field) || ("params" == field)) {
                  try {
                     code[field] = JSON.parse(curr_mr_editor.session.getValue())
                  } catch (err) {} //(do nothing if it's not valid JSON)
               } else {
                  code[field] = curr_mr_editor.session.getValue()
               }
            })
        })
      })

      // Resize each editor if its accordion is opened
      mapReduceFields_.forEach(function(field) {
          $(`#accordion_${field}_agg_${index}`).on('shown.bs.collapse', function () {
             ace.edit(`${field}_agg_${index}`).resize()
          })
      })
   }

</script>
