<script>

//TODO: make some of these JSON boxes small?

   /** Builds the forms that define the generation of Aggregation queries */
   function buildAggregationEditor(index) {
       var accordion =
       `
<div id="accordion_agg_${index}" class="panel-group">
    <div class="panel panel-default">
        <div class="panel-heading">
            <h4 class="panel-title">
                <a data-toggle="collapse" data-parent="#accordion_agg_${index}" href="#accordion_general_agg_${index}">General</a>
            </h4>
        </div>
        <div id="accordion_general_agg_${index}" class="panel-collapse collapse out">
            <div class="panel-body form-horizontal">
               ${buildGeneralEditor(index, 'agg')}
            </div>
        </div>

        <div class="panel-heading">
            <h4 class="panel-title">
                <a data-toggle="collapse" data-parent="#accordion_agg_${index}" href="#accordion_query_agg_${index}">Query</a>
            </h4>
        </div>
        <div id="accordion_query_agg_${index}" class="panel-collapse collapse in">
            <div class="panel-body">
               <div id="query_agg_${index}" class="medium_ace_editor"></div>
            </div>
        </div>

        <div class="panel-heading">
            <h4 class="panel-title">
                <a data-toggle="collapse" data-parent="#accordion_agg_${index}" href="#accordion_buckets_agg_${index}">Buckets</a>
            </h4>
        </div>
        <div id="accordion_buckets_agg_${index}" class="panel-collapse collapse in">
            <div class="panel-body">
               <div id="buckets_agg_${index}"></div>
               <div class="btn-toolbar">
                  <button class="btn btn-default" id="add_bucket_agg_${index}">Add Bucket</button>
               </div>
            </div>
        </div>

        <div class="panel-heading">
            <h4 class="panel-title">
                <a data-toggle="collapse" data-parent="#accordion_agg_${index}" href="#accordion_metrics_agg_${index}">Metrics</a>
            </h4>
        </div>
        <div id="accordion_metrics_agg_${index}" class="panel-collapse collapse in">
            <div class="panel-body">
               <div id="metrics_agg_${index}"></div>
               <div class="btn-toolbar">
                  <button class="btn btn-default" id="add_metric_agg_${index}">Add Metric</button>
               </div>
               <div class="btn-toolbar">
                  <button class="btn btn-default" id="add_mapr_agg_${index}">Add Map Reduce Task</button>
               </div>
            </div>
        </div>

       <!------------------------------------------------------------------------------------->
       <hr/>

        <div class="panel-heading">
            <h4 class="panel-title">
                <a data-toggle="collapse" data-parent="#accordion_agg_${index}" href="#accordion_params_agg_${index}">(MR) Parameters</a>
            </h4>
        </div>
        <div id="accordion_params_agg_${index}" class="panel-collapse collapse in">
            <div class="panel-body">
               <div id="params_agg_${index}" class="medium_ace_editor"></div>
            </div>
        </div>

        <div class="panel-heading">
            <h4 class="panel-title">
                <a data-toggle="collapse" data-parent="#accordion_agg_${index}" href="#accordion_init_agg_${index}">(MR) Init Script</a>
            </h4>
        </div>
        <div id="accordion_init_agg_${index}" class="panel-collapse collapse in">
            <div class="panel-body">
               <div id="init_agg_${index}" class="medium_ace_editor"></div>
            </div>
        </div>

        <div class="panel-heading">
            <h4 class="panel-title">
                <a data-toggle="collapse" data-parent="#accordion_agg_${index}" href="#accordion_map_agg_${index}">(MR) Map Script</a>
            </h4>
        </div>
        <div id="accordion_map_agg_${index}" class="panel-collapse collapse in">
            <div class="panel-body">
               <div id="map_agg_${index}" class="ace_editor"></div>
            </div>
        </div>

        <div class="panel-heading">
            <h4 class="panel-title">
                <a data-toggle="collapse" data-parent="#accordion_agg_${index}" href="#accordion_combine_agg_${index}">(MR) Combine Script</a>
            </h4>
        </div>
        <div id="accordion_combine_agg_${index}" class="panel-collapse collapse in">
            <div class="panel-body">
               <div id="combine_agg_${index}" class="ace_editor"></div>
            </div>
        </div>

        <div class="panel-heading">
            <h4 class="panel-title">
                <a data-toggle="collapse" data-parent="#accordion_agg_${index}" href="#accordion_reduce_agg_${index}">(MR) Reduce Script</a>
            </h4>
        </div>
        <div id="accordion_reduce_agg_${index}" class="panel-collapse collapse in">
            <div class="panel-body">
               <div id="reduce_agg_${index}" class="ace_editor"></div>
            </div>
        </div>

        <div class="panel-heading">
            <h4 class="panel-title">
                <a data-toggle="collapse" data-parent="#accordion_agg_${index}" href="#accordion_lib_agg_${index}">(MR) Library Functions</a>
            </h4>
        </div>
        <div id="accordion_lib_agg_${index}" class="panel-collapse collapse in">
            <div class="panel-body">
               <div id="lib_agg_${index}" class="ace_editor"></div>
            </div>
        </div>
    </div>
</div>
       `
     return accordion
   }

   /** Handles elements that need custom redraw logic if the underlying fields were changed */
   function onSelectAggregationEditor(index, selected, curr_editor) {
      // Update top-level JSON since we're switching mode
      updateRawJson(curr_editor, function(currJson) {
           var aggregationTable = getOrPutJsonObj(currJson, [ "aggregation_table" ])
           aggregationTable.enabled = selected
      })
      // Display redraw:
      if (selected) {
         ace.edit(`query_agg_${index}`).resize()
         ace.edit(`params_agg_${index}`).resize()
         ace.edit(`init_agg_${index}`).resize()
         ace.edit(`map_agg_${index}`).resize()
         ace.edit(`combine_agg_${index}`).resize()
         ace.edit(`reduce_agg_${index}`).resize()
         ace.edit(`lib_agg_${index}`).resize()

         //TODO bucket and metrics
      }
   }

   /** Populate the data for this form */
   function populateAggregationEditor(index, name, json, curr_sql_editor) {

   //TODO
   /*
       var sqlEditor = curr_sql_editor || ace.edit(`editor_sql_${index}`)
       populateGeneralEditor(index, name, json, 'agg')
       var sql = getJson(json, [ "sql_table", "query" ]) || ""
       sqlEditor.session.setValue(sql)
       */

       //TODO: (close tabs)
   }

   /** Called once all the HTML elements for this SQL table exist, populates the data and registers event handlers */
   function registerAggregationEditor(index, name, json, curr_editor) {
      //TODO

      var editors = [
      `query_agg_${index}`, `params_agg_${index}`, `init_agg_${index}`, `map_agg_${index}`, `combine_agg_${index}`,
      `reduce_agg_${index}`, `lib_agg_${index}`
      ]
      editors.forEach(function(editor) {
           var curr_editor = ace.edit(editor)
           if ((0 == editor.indexOf("query")) || (0 == editor.indexOf("params"))) {
              curr_editor.session.setMode("ace/mode/json")
           } else {
              curr_editor.session.setMode("ace/mode/java")
           }
           curr_editor.session.setTabSize(3)
           curr_editor.session.setUseWrapMode(true)
           curr_editor.session.setValue("//TODO")
      })

      $(`#add_bucket_agg_${index}`).click(function(){
         buildAggregationForm(index, 'bucket', `buckets_agg_${index}`)
      })
      $(`#add_metric_agg_${index}`).click(function(){
         buildAggregationForm(index, 'metric', `metrics_agg_${index}`)
      })
      $(`#add_mapr_agg_${index}`).click(function(){
         buildAggregationForm(index, 'mapr', `metrics_agg_${index}`)
      })

}
</script>a
