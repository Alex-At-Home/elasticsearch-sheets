
<script src="https://cdnjs.cloudflare.com/ajax/libs/elasticsearch/15.3.1/elasticsearch.min.js"></script>

<script>

    // Interface with UI

    /** Populate a data table from a query */
    function populateTable(tableName, tableConfig) {
       for (var key in tableToQueryMapping) {
          var enabled = getJson(tableConfig, [ key, "enabled" ]) || false
          if (enabled) {
             // Check that the common section doesn't include any incompatible visual elements
             var queryType = tableToQueryMapping[key]
             if (!queryType.hasQueryBar) {
                getOrPutJsonObj(tableConfig, [ "common", "query" ]).source = "none"
             }
             performGenericOperation(tableName, tableConfig, queryType.fn)
             break
          }
       }
    }

   // Internals

   /** Keeps track of the different clients built so we don't keep rebuilding them (apart from sidebar reloads) */
   var _clientState = {

      clients: {},

      getOrBuildClient: function(esMeta) {
         var esMetaStr = JSON.stringify(esMeta)
         if (this.hasOwnProperty(esMetaStr)) {
            return this[esMetaStr]
         } else { // Build client
            var options = {
               host: esMeta.url
            }
            if (esMeta.auth_type == "password") {
               options.httpAuth = esMeta.username + ":" + esMeta.password
            }
            if (esMeta.version != "") { //(else default)
               options.version = esMeta.version
            }
            var client_options = esMeta.client_options_json || {}
            for (var key in client_options) {
               options[key] = client_options[key]
            }
            return new elasticsearch.Client(options)
         }
      }
   }

   /** Launches an ES client operation */
   function performGenericOperation(tableName, tableConfig, operationLogicFn) {
      google.script.run.withSuccessHandler(function(obj) {
         if (obj && (obj.es_meta.enabled || true)) { //(null used to return error which server has already handled)
            //TODO: all sorts of works still to be done on auth
            if (("password" == obj.es_meta.auth_type) && ("" == obj.es_meta.password)) {
               google.script.run.launchElasticsearchConfig()
            } else {
               operationLogicFn(tableName, tableConfig, obj, _clientState.getOrBuildClient(obj.es_meta))
            }
         }
      }).withFailureHandler(function(obj) {
         showStatus("Failed to retrieve ES metadata: [" + JSON.stringify(obj) + "]")
      }).getElasticsearchMetadata(tableName, tableConfig)
   }

   /** Launches a SQL query */
   function performSqlQuery(tableName, tableConfig, esAndTableMeta, esClient) {
      var tableMeta = esAndTableMeta.table_meta
      var userQuery = tableMeta.query || "True"
      var pagination = ""
      if (tableMeta.page_info_offset) {
         var rowsToPull = tableMeta.page*tableMeta.data_size + 1 // ES SQL currently doesn't support full pagination so have to grovel
         //(grab +1 so we know if there are more pages)
         pagination = "LIMIT " + rowsToPull
      }
      var fullSqlQuery = tableConfig.sql_table.query
         .replace("$$query", userQuery)
         .replace("$$pagination", pagination)

      esClient.transport.request({
         method: "POST",
         path: "/_xpack/sql?format=json",
         body: { "query": fullSqlQuery },
         headers: esAndTableMeta.es_meta.headers
      }, function(err, response, status) {
         var result = {}
         // Error or response
         if (err) { result.err = err.message }
         else { result.response = response }
         // (always get status)
         if (status) { result.status = status }

         google.script.run.handleSqlResponse(tableName, tableConfig, esAndTableMeta, result, fullSqlQuery)
      })
   }

   /** Launches a _cat query */
   function performCatQuery(tableName, tableConfig, esAndTableMeta, esClient) {

      var endpoint = getJson(tableConfig , [ "cat_table", "endpoint" ]) || ""
      var options = (getJson(tableConfig , [ "cat_table", "options" ]) || [])
      var catQuery = `/_cat/${endpoint}?format=json` + (options.length > 0 ? '&' : '') + options.join("&")

      esClient.transport.request({
         method: "GET",
         path: catQuery,
         headers: esAndTableMeta.es_meta.headers
      }, function(err, response, status) {
         var result = {}
         // Error or response
         if (err) { result.err = err.message }
         else { result.response = response }
         // (always get status)
         if (status) { result.status = status }

         google.script.run.handleCatResponse(tableName, tableConfig, esAndTableMeta, result, catQuery)
      })
   }

   // Map to write method

   //TODO other methods

   var tableToQueryMapping = {
       "cat_table": { fn: performCatQuery, hasQueryBar: false },
       "sql_table": { fn: performSqlQuery, hasQueryBar: true }
   }

</script>
