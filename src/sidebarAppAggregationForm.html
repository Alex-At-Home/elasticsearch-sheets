<script>

   var aggFormSuggestionList_ = {
      bucket: Object.keys(aggFormSuggestionMap.bucket),
      metric: Object.keys(aggFormSuggestionMap.metric)
   }
   var aggFormOneUp_ = 0 //global across all indices - not an index just a uuid

   /** Builds the UI element that manages data tables (aggregationType one of `bucket`, `metric`, `mapr` */
   function buildAggregationForm(index, aggregationType, globalEditor, parentContainerId, json) {

      var jsonIsCollapsed = json ? "" : "in" // (collapse the JSON if populating from existing data)
      var isNewElement = json ? false : true
      var json = json || {}

      var subIndex = ++aggFormOneUp_

      var elementIdSuffix = `agg_${aggregationType}_${index}_${subIndex}`

      var aggregationTypeTemplate =
      `
              <div class="input-group">
                <div class="input-group-addon for-shorter-text">
                  <span class="input-group-text">Type</span>
                </div>
                <input type="text" class="form-control" placeholder="Aggregation type" value="${json.agg_type || ''}" id="agg_type_${elementIdSuffix}">
                <div class="input-group-addon hidden" id="help_agg_type_${elementIdSuffix}">
                   <span class="input-group-text"><a target="_blank">?</a></span>
                </div>
              </div>
      `

      var jsonInfo = ""
      if ("mapr" == aggregationType) {
         aggregationTypeTemplate =
         `
              <div class="input-group">
                <div class="input-group-addon for-shorter-text">
                  <span class="input-group-text">Type</span>
                </div>
                <input type="text" class="form-control" placeholder="Aggregation type" value="Map Reduce, see (MR) below" id="mr_info_${elementIdSuffix}" disabled>
                <div class="input-group-addon" id="help_agg_type_${elementIdSuffix}">
                   <span class="input-group-text"><a target="_blank" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-metrics-scripted-metric-aggregation.html">?</a></span>
                </div>
              </div>
         `
         jsonInfo =
         `
         <label>Extra Parameters To Merge:</label>
         `
      }

//TODO make names of existing fields non-editable? like with data table accordion?
//(the reason is that once we start allowing specification of a parent it becomes tricky to edit these on the fly)

      var form =
      `
          <div class="form aggregation_form_element" id="form_${elementIdSuffix}">
            <div class="form-group">

              <div class="btn-toolbar">
                 <div class="btn-group">
                    <button id="toggle_config_${elementIdSuffix}" class="btn btn-xs btn-default" type="button" data-toggle="tooltip" title="Show/hide JSON config">
                     <a data-toggle="collapse" href="#collapse0_${elementIdSuffix}"><span class='glyphicon glyphicon-wrench'></span></a>
                    </button>
                 </div>
                 <div class="btn-group">
                    <button id="move_up_${elementIdSuffix}" class="btn btn-xs btn-default" type="button" data-toggle="tooltip" title="Move aggregation up"><span class='glyphicon glyphicon-menu-up'></span></button>
                    <button id="move_down_${elementIdSuffix}" class="btn btn-xs btn-default" type="button" data-toggle="tooltip" title="Move aggregation down"><span class='glyphicon glyphicon-menu-down'></span></button>
                 </div>
                 <div class="btn-group">
                    <button id="delete_${elementIdSuffix}" class="btn btn-xs btn-default" type="button" data-toggle="tooltip" title="Delete aggregation"><span class='glyphicon glyphicon-remove-sign'></span></button>
                 </div>
              </div>

              <div class="input-group">
                <div class="input-group-addon for-shorter-text">
                  <span class="input-group-text">Name</span>
                </div>
                <input type="text" class="form-control" placeholder="Field name" value="${json.name || ''}" id="name_${elementIdSuffix}">
              </div>

              ${aggregationTypeTemplate}

              <div id="collapse0_${elementIdSuffix}" class="panel-collapse collapse ${jsonIsCollapsed}">

                 ${jsonInfo}

                 <div id="editor_${elementIdSuffix}" class="medium_ace_editor">
                 </div>

                 <div class="panel-group">
                   <div class="panel panel-default">
                      <label>
                         <a data-toggle="collapse" href="#collapse1_${elementIdSuffix}">Advanced</a>
                      </label>
                      <div id="collapse1_${elementIdSuffix}" class="panel-collapse collapse">

                      <div class="input-group">
                         <div class="input-group-addon for-shorter-text">
                            <span class="input-group-text">Fields</span>
                         </div>
                         <input type="text" class="form-control" placeholder="[+-]glob (** crosses .s)" value="${json.field_filter || ''}" id="field_filter_${elementIdSuffix}">
                      </div>

                      <div class="input-group">
                         <div class="input-group-addon for-shorter-text">
                            <span class="input-group-text">Location</span>
                         </div>
                         <select class="form-control for-shorter-text" value="${json.location || 'automatic'}" id="location_${elementIdSuffix}">
                            <option value="automatic">Automatic</option>
                            <option value="disabled">Disabled</option>
                            <!-- TODO fill with other names -->
                         </select>
                       </div>
                     </div>
                   </div>
                 </div>
               </div>
            </div>
          </div>
      `

      $(`#${parentContainerId}`).append(form).append(function(){

         // When complete...
         // Push the new (empty) JSON into the array
         if (isNewElement) {
            var insertPath = getAggFormPath_(aggregationType)
            updateRawJsonNow(globalEditor, function(currJson) {
               var arrayToAppend = getOrPutJsonArray(currJson, insertPath)
               arrayToAppend.push({})
            })
         }

         // Build JSON editor
         var curr_editor = ace.edit(`editor_${elementIdSuffix}`)
         curr_editor.session.setMode("ace/mode/json")
         curr_editor.session.setTabSize(3)
         curr_editor.session.setUseWrapMode(true)
         curr_editor.session.setValue(JSON.stringify(json.config || {}, null, 3))

         // Set-up autocomplete on type:
         if ("mapr" != aggregationType) {
            var mySuggestions =  aggFormSuggestionList_[aggregationType]
            var selectOrChange = function(newValue) {
               updateRawJsonNow(globalEditor, function(currJson) {
                  var currJsonForm = getCurrAggFormJson_($(`#form_${elementIdSuffix}`), parentContainerId, aggregationType, currJson)

                  var selected = newValue
                  var newJson = JSON.parse(JSON.stringify(aggFormSuggestionMap[aggregationType][selected] || {}, null, 3))
                  var url = newJson['url__']
                  if (url) { // set href for "? and show
                     $(`#help_agg_type_${elementIdSuffix} a`).attr("href", url)
                     $(`#help_agg_type_${elementIdSuffix}`).removeClass('hidden')
                  } else {
                     $(`#help_agg_type_${elementIdSuffix} a`).removeAttr("href")
                     $(`#help_agg_type_${elementIdSuffix}`).addClass('hidden')
                  }
                  delete newJson['url__']
                  var newJsonStr = JSON.stringify(newJson, null, 3)
               //TODO: get JSON element, get current type, get suggestion for that, if different then ask?

                  curr_editor.session.setValue(newJsonStr)
                  currJsonForm.agg_type = newValue
                  currJsonForm.config = newJson
               })
            }
            $(`#agg_type_${elementIdSuffix}`).autocomplete({
               minLength: 0,
               source: function(request, response) {
                  var data = $.grep(mySuggestions, function(value) {
                     return value.substring(0, request.term.length).toLowerCase() == request.term.toLowerCase()
                  });
                  response(data)
               },
               select: function(event, ui) { selectOrChange(ui.item.value) },
               change: function(event, ui) { selectOrChange($(`#agg_type_${elementIdSuffix}`).val()) }
            }).focus(function () {
               if ("" == $(this).val()) { // only insta-display options if textbox empty
                  $(this).autocomplete("search", "")
               }
            })
         }

         // Handle the control buttons
         $(`#move_up_${elementIdSuffix}`).click(function(){
            //TODO: move in JSON and then...
            var prev = $(`#form_${elementIdSuffix}`).prev()
            $(`#form_${elementIdSuffix}`).insertBefore(prev)
         })
         $(`#move_down_${elementIdSuffix}`).click(function(){
            //TODO: move in JSON and then...
            var next = $(`#form_${elementIdSuffix}`).next()
            $(`#form_${elementIdSuffix}`).insertAfter(next)
         })
         $(`#delete_${elementIdSuffix}`).click(function(){
             google.script.run.withSuccessHandler(function(obj) {
             if (obj) {
                updateRawJsonNow(globalEditor, function(currJson) {
                   var subIndex = getCurrAggFormJsonIndex_($(`#form_${elementIdSuffix}`), parentContainerId)
                   deleteCurrAggFormJson_(subIndex, aggregationType, currJson)
                })
                $(`#form_${elementIdSuffix}`).remove()
             }
           }).launchYesNoPrompt("Delete metric", "Are you sure you want to delete this metric?")
         })

         // Other change handlers:

         curr_editor.session.on('change', function(delta) {
            updateRawJson(globalEditor, function(currJson) {
               var currJsonForm = getCurrAggFormJson_($(`#form_${elementIdSuffix}`), parentContainerId, aggregationType, currJson)
               try {
                  currJsonForm.config = JSON.parse(curr_editor.session.getValue())
               } catch (err) { //(do nothing if it's not valid JSON)
               }
            })
         })

         //TODO handle other fields (JSON/location/name/field filter)
      })
   }

   /** Handy utility for pointing at the right aggregation array */
   function getAggFormPath_(aggregationType) {
      if ("bucket" == aggregationType) {
         return [ "aggregation_table", "buckets" ]
      } else {
         return [ "aggregation_table", "metrics" ]
      }
   }
   /** Removes the JSON element at the specified index */
   function deleteCurrAggFormJson_(subIndex, aggregationType, parentJson) {
      var jsonArray = getOrPutJsonArray(parentJson, getAggFormPath_(aggregationType))
      jsonArray.splice(subIndex, 1)
   }
   /** Moves the JSON element at the specified index */
   function moveCurrAggFormJson_(subIndex, offset, aggregationType, parentJson) {
      //TODO
   }
   /** Returns the JSON element at the specified index */
   function getCurrAggFormJson_(formDiv, parentContainerId, aggregationType, parentJson) {
      var index = getCurrAggFormJsonIndex_(formDiv, parentContainerId)
      var jsonArray = getJson(parentJson, getAggFormPath_(aggregationType)) || []
      return jsonArray[index]
   }
   /** Returns the index of the specified form */
   function getCurrAggFormJsonIndex_(formDiv, parentContainerId) {
      var index = $(`#${parentContainerId} .aggregation_form_element`).index(formDiv)
      return index
   }

</script>
